#user  nobody;
worker_processes  16;
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
error_log  logs/error.log  info;
# error_log  logs/error.log  crit;

pid        logs/nginx.pid;

worker_rlimit_nofile 655350;
events {
    use epoll;
    worker_connections  65535;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 50M;
    
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;
    ##防止CC攻击####
    #limit_zone one  $binary_remote_addr  10m;
    limit_req_zone  $binary_remote_addr  zone=req_one:10m rate=400r/s;
    #限制IP并发数与下载速度
    limit_conn_zone $binary_remote_addr zone=req_download:10m;
    
    keepalive_timeout  120;
    server_tokens off;
    
    gzip  on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_comp_level 9;
    gzip_types text/plain application/x-javascript text/css application/javascript application/xml text/javascript 
    application/x-htpd-php image/jpeg image/gif image/png image/jpg;
    gzip_vary off;
    gzip_disable "MSIE [1-6]\.";
    
    ##cache20150910##
    proxy_connect_timeout 3600;
    proxy_read_timeout 3600;
    proxy_send_timeout 3600;
    proxy_buffer_size 16k;
    proxy_buffers 4 64k;
    proxy_busy_buffers_size 128k;
    proxy_temp_file_write_size 128k;
    
    ####################################20151224
    client_header_buffer_size 512k;
    large_client_header_buffers 4 512k;
    
    #####nginx报499错误
    proxy_ignore_client_abort on;
    
    ############
    #proxy_temp_path /opt/nginx/temp_dir;
    #proxy_cache_path /opt/nginx/cache levels=1:2 keys_zone=cache_one:20m inactive=1d max_size=10g;
    ##end##
    
    upstream wms{
	    	ip_hash;
				server 10.45.179.90:8080;
	    	server 10.45.182.231:8080;
		}			
    upstream sekorm{
				ip_hash;
	      server 10.45.179.90:8081;
	      server 10.45.182.231:8081;
		}
    upstream card {
				ip_hash;
	      server 10.45.179.90:8082;
	      server 10.45.182.231:8082;
		}		
    upstream cardApi {
				ip_hash;
	      server 10.45.179.90:8082;
	      server 10.45.182.231:8082;
		}		
    upstream wmsApi{
				ip_hash;
	      server 10.45.179.90:8082;
	      server 10.45.182.231:8082;
		}		
    upstream osmApi {
				ip_hash;
	      server 10.45.179.90:8083;
	      server 10.45.182.231:8083;
		}		
    upstream sync {
		    ip_hash;
	      server 10.45.179.90:8083;
	      server 10.45.182.231:8083;
   	}													
    upstream ecp {
				ip_hash;
	      server 10.45.179.90:8084;
	      server 10.45.182.231:8084;
		}
    upstream bdm {
				ip_hash;
	      server 10.45.179.90:8084;
	      server 10.45.182.231:8084;
		}	
    upstream member {
				ip_hash;
	      server 10.45.179.90:8085;
	      server 10.45.182.231:8085;
		}		
    upstream memberApi {
				ip_hash;
	      server 10.45.179.90:8085;
	      server 10.45.182.231:8085;
		}
    upstream recom {
				ip_hash;
	      server 10.45.179.90:8086;
	      server 10.45.182.231:8086;
		}		
    upstream searchEngine {
        ip_hash;
	      server 10.45.179.90:8086;
	      server 10.45.182.231:8086;
		}		
    upstream rgc {
	    	ip_hash;
	      server 10.45.179.90:8087;
	      server 10.45.182.231:8087;
    }
    upstream acti {
        ip_hash;
        server 10.45.179.90:8087;
        server 10.45.182.231:8087;
    }
    upstream actiApi {
        ip_hash;
        server 10.45.179.90:8087;
        server 10.45.182.231:8087;
    }			
    upstream stat {
	      ip_hash;
	      server 10.45.179.90:8089;
	      server 10.45.182.231:8089;
    }
    upstream statApi {
	    	ip_hash;
	      server 10.45.179.90:8089;
	      server 10.45.182.231:8089;
    }
    
    server {
	  		listen       80;
        listen       443 ssl;
	      server_name www.sekorm.com  sekorm.com;
        ssl_certificate /opt/nginx/conf/20160525_wotong_ssl/sekorm.crt;
        ssl_certificate_key /opt/nginx/conf/20160525_wotong_ssl/sekorm.key;
	      
	      #不带www的转跳
	     	if ($host != 'www.sekorm.com') {
      			rewrite ^/(.*)$ http://www.sekorm.com/$1 permanent;
  			}
	      	      	 
				#防止CC攻击###
	      #limit_conn   one  1;
	      limit_req   zone=req_one  burst=2000;
	   
	    	location ~/(behind|front|common)/.*\.(gif|jpeg|jpg|png|bmp|swf|ioc|flv|html|wma|js|css|doc|map|ico|txt|eot|svg|ttf|woff)$ {
						root html;
	         	expires 1d;    
		    }
		    	
		    location = /favicon.ico {
        		root html/front/website;
    		} 
        
        location ~/robots.txt {
        		root html;
        }
        
        location ~/ip.html {
        		root html;
        }
        
        location ~/apple-app-site-association {
            root html;
        }
    
	    	location ~/app {
						root /opt/nginx/html/front/website;
						index    index.html;
	      }	
	      	      				
				location ^~/bdm {
        		proxy_pass http://ecm.sekorm.com/bdm;
        } 
				
				location ^~/rgc {
						proxy_pass http://ecm.sekorm.com/rgc;
				}
				
        location ^~/actiApi {
            proxy_pass http://ecm.sekorm.com/actiApi;
        }
				
				location ^~/memberApi {
						proxy_pass http://ecm.sekorm.com/memberApi;
				}
				
				location ^~/recom {
						proxy_pass http://ecm.sekorm.com/recom;					
				}

				location ^~/searchEngine {
						proxy_pass http://ecm.sekorm.com/searchEngine;
        }	
        
        location ^~/wmsApi {
						proxy_pass http://ecm.sekorm.com/wmsApi;
        }	
        
        location ^~/statApi {
						proxy_pass http://ecm.sekorm.com/statApi;
        }
        	
        location ^~/cardApi {
        		proxy_pass http://ecm.sekorm.com/cardApi;
        }
                
        # portal 专用的配置
        include portal.conf;
										
				location /nginx {
						stub_status on;
						access_log off;
						allow 127.0.0.1;
						allow 120.24.152.68;
						allow 121.15.166.86;
						deny all;
				}
	                                                                                  
	      #error_page  404              /404.html;
	
				# redirect server error pages to the static page /50x.html
				error_page   500 502 503 504  /50x.html;
				location = /50x.html {
				    root   html;
				}    
    }
        
		server{
				listen 80;  
				server_name ecm.sekorm.com;
				#防止CC攻击###
	      #limit_conn   one  1;
	      limit_req   zone=req_one  burst=1500;
		
				location ~/(behind|front|common)/.*\.(gif|jpeg|jpg|png|bmp|swf|ioc|flv|html|wma|js|css|doc|map|ico|txt)$ {
						root html;
	         	expires 1d;    
				}
				
				#首页  
		    rewrite ^/$ /ecp/ permanent;
		    				
				location /ecp {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://ecp;						
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;                                                      
				}	
								
				location /wms {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://wms;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
		
				location /member {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://member;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
				
				location /rgc {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://rgc;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
				
				location /acti {
            proxy_set_header Host $host:80;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://acti;
            access_log off;
            include iplist_in.conf;
            include iplist_company.conf;
            deny all;
        }
                                
        location /actiApi {
            proxy_set_header Host $host:80;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://actiApi;
            access_log off;
            include iplist_in.conf;
            include iplist_company.conf;
            deny all;
        }
        
				location /card {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://card;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
				
				location /cardApi {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://cardApi;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
								
				location /wmsApi {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://wmsApi;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
						
				location /osmApi {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://osmApi;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
				
				location /sync {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://sync;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}	

				location /bdm {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://bdm;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}	
				
				location /memberApi {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://memberApi;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
	
				location /recom {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://recom;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
	
				location /searchEngine {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://searchEngine;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
	
				location /stat {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://stat;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}
	
				location /statApi {
						proxy_set_header Host $host:80;
						proxy_set_header X-Real-IP $remote_addr;
						proxy_pass http://statApi;
						access_log off;
						include iplist_in.conf;
						include iplist_company.conf;
						deny all;
				}	
				
	      #error_page  404              /404.html;
	
				# redirect server error pages to the static page /50x.html
				error_page   500 502 503 504  /50x.html;
				location = /50x.html {
				    root   html;
				}    
		}
}